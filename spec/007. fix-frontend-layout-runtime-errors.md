# 007. Fix Frontend Layout Runtime Errors (Svelte 5 + Favicon)

## Document Information
- **ID**: 007
- **Title**: Fix Frontend Layout Runtime Errors in Svelte 5 (children rendering, asset paths, favicon)
- **Date**: 2026-02-03
- **Status**: Completed

---

## 1. Prompt / Task

**Prompt (user request)**:
"bacalah dan analisa dan pahami AGENTS.md kemudian perbaiki lah semua error ini" with the frontend error log from `npm run dev`.

**Errors to fix (from log)**:
1. `Unexpected token` at `{% if isAuthenticated() %}` in `+layout.svelte`
2. `ReferenceError: children is not defined` in `+layout.svelte`
3. `$: is not allowed in runes mode` in `+layout.svelte`
4. `Internal server error: URI malformed`
5. `Using <slot> ... is deprecated. Use {@render ...}` (warning)
6. `GET /favicon.ico` 404

---

## 2. Goal and Why

**Goal**: Make the SvelteKit frontend run without SSR/compile errors by fixing layout syntax, Svelte 5 runes compatibility, and invalid asset URLs.

**Why**:
- The frontend fails to render due to invalid template syntax and runtime errors.
- Svelte 5 runes mode requires correct children rendering and no legacy reactive statements.
- Invalid `%sveltekit.assets%` usage inside a Svelte component triggers malformed URL handling in Vite.

---

## 3. Codebase Understanding (Relevant to Task)

**Project**: AI Journaling App
- **Frontend**: SvelteKit (Svelte 5, runes mode)
- **Backend**: PocketBase (Go)

**Relevant Files**:
- `frontend/src/routes/+layout.svelte` (root layout, navigation, theme handling, children rendering)
- `frontend/static/` (static assets like favicon)

**Validation Searches**:
- Searched for `{%` templating to confirm no other non-Svelte syntax remains.
- Searched for `%sveltekit.assets%` usage (only in `+layout.svelte`).

---

## 4. Root Cause Analysis

1. **Invalid Svelte template syntax**: `{% if ... %}` is Jinja/Django syntax, not Svelte. This caused the original parse error.
2. **Children snippet undefined**: Using `{@render children()}` without defining `children` via `$props()` caused SSR `ReferenceError`.
3. **Runes mode mismatch**: `$:` reactive statements are disallowed in runes mode.
4. **Malformed URI**: `%sveltekit.assets%` is only valid in `app.html`, not inside Svelte components. It was rendered literally and generated invalid URLs such as `/%sveltekit.assets%/favicon.svg`.
5. **Deprecated `<slot>`**: Svelte 5 warns about `<slot>` in favor of `{@render ...}`.
6. **Missing favicon asset**: No static favicon file existed, leading to 404 requests.

---

## 5. Intended Logic Changes

1. **Use Svelte 5 children snippet properly**:
   - Read `children` from `$props()` as `Snippet`.
   - Render via `{@render children()}`.

2. **Fix asset URLs in layout**:
   - Use `$app/paths` `assets` for favicon path.

3. **Provide actual favicon file**:
   - Add `frontend/static/favicon.svg`.

---

## 6. Code Changes Implemented

### 6.1 `frontend/src/routes/+layout.svelte`
- Added `Snippet` type and `$props()` for children.
- Replaced `<slot />` with `{@render children()}`.
- Replaced `%sveltekit.assets%` with `{assets}` from `$app/paths`.
- Switched `onclick` to Svelte `on:click` for clarity.

### 6.2 `frontend/static/favicon.svg`
- Added a simple SVG favicon to eliminate missing asset errors.

---

## 7. Logic / Pseudocode

```
props = $props()
children = props.children

head:
  favicon = assets + '/favicon.svg'

render:
  if isAuthenticated:
    show nav
  main:
    render children snippet
```

---

## 8. Testcase Simulation / Tracing

**No explicit test cases provided by user.**

**Expected runtime trace after fix**:
1. `npm run dev` starts without SSR compile errors.
2. Layout renders without `{% ... %}` parse error.
3. `children` renders nested routes without ReferenceError.
4. Browser requests `/favicon.svg` (valid), no `URI malformed`.

---

## 9. Manual Testing Plan

1. **Start dev server**
   ```bash
   cd frontend
   npm run dev
   ```

2. **Open app**
   - Visit `http://localhost:5173/`
   - Expected: page renders, no 500 SSR errors.

3. **Verify favicon**
   - Check browser network tab for `favicon.svg` status 200.
   - Confirm no `URI malformed` errors.

4. **Auth nav behavior**
   - Login to show navigation.
   - Logout button clears auth without errors.

---

## 10. Notes / Risks

- If browsers still request `/favicon.ico` automatically, add a `favicon.ico` later.
- If `children` is still not provided, fallback to `<slot />` with a temporary suppression of the deprecation warning.

---

**END OF SPECIFICATION**
