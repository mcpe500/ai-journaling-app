# Spec: Fix Migration 002 - Missing CollectionId in RelationField

**Document ID**: 004  
**Title**: Fix "collectionId: cannot be blank" Error in Growth Analysis Migration  
**Date**: 2026-02-03  
**Status**: Completed  

---

## 1. TASK ANALYSIS

### 1.1 Original Problem

Server failed to start with migration error:
```
Error: Failed to apply migration 002_growth_analysis.go: 
fields: (11: (collectionId: cannot be blank.).).
```

### 1.2 Root Cause

In `002_growth_analysis.go`, the migration created a `RelationField` named `related_entries` but didn't specify which collection it relates to:

```go
growthAnalysis.Fields.Add(&core.RelationField{
    Name:     "related_entries",
    MaxSelect: 100,
})
```

**The Issue**:
- `RelationField` requires a `CollectionId` to know which collection to relate to
- Field index 11 (the 11th field added, which is `related_entries`) has no `CollectionId`
- PocketBase validation rejected the field: "collectionId: cannot be blank"
- This is a many-to-many relation from `growth_analysis` to `journal_entries`

### 1.3 Why This Happened

In PocketBase v0.23+, when creating a `RelationField` programmatically, you MUST provide:
- `CollectionId` - the ID of the target collection to relate to
- This is different from defining relations in the UI where you select from a dropdown

The code created a relation field but forgot to reference the `journal_entries` collection.

---

## 2. CODEBASE UNDERSTANDING

### 2.1 Affected File

**File**: `backend/migrations/002_growth_analysis.go`
**Lines**: 92-95 (original), 11-20 and 96-102 (fix)

### 2.2 Original Code

```go
// Only got users collection
users, err := app.FindCollectionByNameOrId("_pb_users_auth_")

// ... field definitions ...

// Related journal entries (many-to-many relation) - ❌ MISSING CollectionId
growthAnalysis.Fields.Add(&core.RelationField{
    Name:     "related_entries",
    MaxSelect: 100,
})
```

### 2.3 Field Structure

The `growth_analysis` collection has these fields (in order):
1. `user` (RelationField) ✅ has CollectionId
2. `analysis_type` (SelectField)
3. `period_start` (DateField)
4. `period_end` (DateField)
5. `encrypted_insights` (TextField)
6. `growth_score` (NumberField)
7. `key_themes` (JSONField)
8. `emotional_trend` (SelectField)
9. `action_items` (JSONField)
10. `motivation_quote` (TextField)
11. `related_entries` (RelationField) ❌ NO CollectionId - THIS WAS THE ERROR

---

## 3. SOLUTION

### 3.1 What Was Changed

**File**: `backend/migrations/002_growth_analysis.go`

**Changes Made**:

1. **Added lookup for journal_entries collection** (lines 17-20):
```go
entries, err := app.FindCollectionByNameOrId("journal_entries")
if err != nil {
    return err
}
```

2. **Fixed the RelationField with CollectionId** (lines 96-102):
```go
// Related journal entries (many-to-many relation)
growthAnalysis.Fields.Add(&core.RelationField{
    Name:          "related_entries",
    CollectionId:  entries.Id,  // ✅ Added - references journal_entries
    MaxSelect:     100,         // Support weekly/monthly analyses
    CascadeDelete: false,       // Don't delete entries when analysis deleted
})
```

### 3.2 Why CascadeDelete is false

For the `related_entries` relation:
- `CascadeDelete: false` - When a growth analysis is deleted, don't delete the journal entries
- This is correct for many-to-many relations
- Journal entries should remain even if analysis is deleted
- One entry can be referenced by multiple analyses (daily, weekly, monthly)

Compare to `user` relation:
- `CascadeDelete: true` - When user is deleted, delete all their analyses
- This is correct for ownership relations

---

## 4. VALIDATION

### 4.1 Code Review

- [x] Added lookup for `journal_entries` collection
- [x] Added `CollectionId: entries.Id` to RelationField
- [x] Added `CascadeDelete: false` (appropriate for many-to-many)
- [x] Error handling in place for collection lookups
- [x] No breaking changes to data model

### 4.2 Migration Order Consideration

**Important**: Migration 002 depends on migration 001
- Migration 001 creates `journal_entries` collection
- Migration 002 references `journal_entries` collection
- This is correct because migrations run in numerical order (001 → 002 → 003)

### 4.3 Expected Behavior After Fix

1. Server starts without migration errors
2. `growth_analysis` collection created successfully
3. All fields created with proper configuration
4. `related_entries` field properly linked to `journal_entries` collection

---

## 5. TESTING PLAN

### 5.1 Manual Testing Steps

1. **Clear Database** (if migrations partially applied):
   ```bash
   rm -rf backend/pb_data/
   ```

2. **Start Server**:
   ```bash
   cd backend
   go run main.go serve
   ```
   Expected: Server starts without migration errors

3. **Verify Collections**:
   - Access PocketBase Admin UI (http://localhost:8090/_/)
   - Check `growth_analysis` collection exists
   - Verify `related_entries` field has correct settings

4. **Verify Relations**:
   - Check that `related_entries` shows relation to `journal_entries`
   - Verify field can hold multiple entries (MaxSelect: 100)

### 5.2 Relation Configuration

**Field**: `related_entries`
| Property | Value | Notes |
|----------|-------|-------|
| Type | Relation | Links to other records |
| Collection | journal_entries | References journal entries |
| MaxSelect | 100 | Supports weekly/monthly batch analysis |
| CascadeDelete | false | Preserves entries if analysis deleted |

---

## 6. FILES MODIFIED

| File | Change Type | Description |
|------|-------------|-------------|
| `backend/migrations/002_growth_analysis.go` | Fix | Added CollectionId lookup and set it on related_entries RelationField |

---

## 7. LESSONS LEARNED

### 7.1 RelationField Requirements

In PocketBase v0.23 Go API, `RelationField` requires these mandatory fields:

```go
&core.RelationField{
    Name:         "field_name",     // Required: field name
    CollectionId: "collection_id",  // Required: target collection ID
    MaxSelect:    1,                // Optional: default 1
    // Optional fields:
    Required:      false,  // Whether field is required
    CascadeDelete: false,  // Delete related records when this deleted
    MinSelect:     0,      // Minimum relations required
}
```

**Common Error**: Forgetting `CollectionId` results in: "collectionId: cannot be blank"

### 7.2 CascadeDelete Best Practices

| Relation Type | CascadeDelete | Example |
|--------------|---------------|---------|
| Ownership (parent-child) | true | User → Growth Analysis (delete analyses when user deleted) |
| Reference (many-to-many) | false | Growth Analysis → Journal Entries (keep entries if analysis deleted) |
| Composition | true | Order → Order Items (delete items when order deleted) |

### 7.3 Migration Dependencies

When a migration references another collection:
1. Ensure the target collection is created in an earlier migration
2. Use `app.FindCollectionByNameOrId()` to get the collection ID
3. Handle errors appropriately (migration should fail if dependency missing)

```go
// Good: Check for dependency
targetCollection, err := app.FindCollectionByNameOrId("target_collection")
if err != nil {
    return err  // Fail migration if dependency doesn't exist
}

// Use the ID
relationField.CollectionId = targetCollection.Id
```

---

## 8. RELATED DOCUMENTATION

- Spec 001: AI Journaling App Architecture
- Spec 002: Fix PocketBase Hook Compilation Error
- Spec 003: Fix Migration Index Error
- PocketBase Go Documentation: https://pocketbase.io/docs/go-overview/

---

**END OF SPECIFICATION**
