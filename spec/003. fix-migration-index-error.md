# Spec: Fix Migration Index Error - Missing 'created' Column

**Document ID**: 003  
**Title**: Fix SQL Logic Error - No Such Column 'created' in Migration  
**Date**: 2026-02-03  
**Status**: Completed  

---

## 1. TASK ANALYSIS

### 1.1 Original Problem

Server failed to start with migration error:
```
Error: Failed to apply migration 001_initial_journal_schema.go: 
indexes: (1: Failed to create index idx_entries_user_created - 
SQL logic error: no such column: created (1)..).
```

### 1.2 Root Cause

In `001_initial_journal_schema.go`, the migration attempted to create an index on a column that doesn't exist:

```go
entries.AddIndex("idx_entries_user_created", false, "user,created", "")
```

**The Issue**:
- `created` is an auto-generated field in PocketBase (like `updated`)
- When creating collections programmatically via `core.NewBaseCollection()`, these auto-fields are NOT automatically added
- The index referenced `created` column, but it wasn't defined in the collection schema
- SQL error occurred: "no such column: created"

### 1.3 Why This Happened

In PocketBase v0.23+, when you create a collection through the UI or API, `created` and `updated` fields are automatically added as `AutodateField`. However, when creating collections programmatically in Go migrations, you must explicitly add ALL fields including the autodate fields if you want to reference them in indexes.

---

## 2. CODEBASE UNDERSTANDING

### 2.1 Affected File

**File**: `backend/migrations/001_initial_journal_schema.go`
**Lines**: 109-112

### 2.2 Original Code

```go
// Add indexes
entries.AddIndex("idx_entries_user_date", false, "user,entry_date", "")
entries.AddIndex("idx_entries_user_created", false, "user,created", "")  // ❌ ERROR
tries.AddIndex("idx_entries_entry_date", false, "entry_date", "")
```

### 2.3 Field Definitions

The migration defined these fields:
- `user` (RelationField) ✅
- `entry_date` (DateField) ✅
- `encrypted_content` (TextField) ✅
- `content_hash` (TextField) ✅
- `mood_rating` (NumberField) ✅
- `tags` (JSONField) ✅
- `word_count` (NumberField) ✅
- `ai_processed` (BoolField) ✅

**Missing**: 
- `created` (AutodateField) - auto-generated by PocketBase but not explicitly added
- `updated` (AutodateField) - auto-generated by PocketBase but not explicitly added

---

## 3. SOLUTION

### 3.1 What Was Changed

**File**: `backend/migrations/001_initial_journal_schema.go:109-112`

**Before**:
```go
// Add indexes
entries.AddIndex("idx_entries_user_date", false, "user,entry_date", "")
entries.AddIndex("idx_entries_user_created", false, "user,created", "")  // ❌ Problematic
entries.AddIndex("idx_entries_entry_date", false, "entry_date", "")
```

**After**:
```go
// Add indexes
entries.AddIndex("idx_entries_user_date", false, "user,entry_date", "")
entries.AddIndex("idx_entries_entry_date", false, "entry_date", "")
```

### 3.2 Why Remove Instead of Add Field?

**Option A - Add the missing fields** (Alternative solution):
```go
// Add autodate fields
entries.Fields.Add(&core.AutodateField{
    Name:     "created",
    OnCreate: true,
})
entries.Fields.Add(&core.AutodateField{
    Name:     "updated",
    OnCreate: true,
    OnUpdate: true,
})

// Then keep the index
entries.AddIndex("idx_entries_user_created", false, "user,created", "")
```

**Option B - Remove the index** (Chosen solution):
```go
// Just remove the problematic index
entries.AddIndex("idx_entries_user_date", false, "user,entry_date", "")
entries.AddIndex("idx_entries_entry_date", false, "entry_date", "")
```

**Rationale for Option B**:
1. `entry_date` is more semantically correct for journaling (the date user wrote the entry)
2. `created` is just the database timestamp (could differ from actual journal date)
3. Query patterns for journal entries typically filter by `entry_date`, not `created`
4. We already have `idx_entries_user_date` which covers user + date queries
5. Less code complexity

### 3.3 Remaining Indexes

| Index Name | Fields | Purpose |
|------------|--------|---------|
| `idx_entries_user_date` | `user,entry_date` | Primary query - user's entries by date |
| `idx_entries_entry_date` | `entry_date` | Date-based queries across users |

---

## 4. VALIDATION

### 4.1 Code Review

- [x] Removed problematic index reference
- [x] Kept essential indexes for query performance
- [x] No breaking changes to data model
- [x] Migration will now apply successfully

### 4.2 Expected Behavior After Fix

1. Server starts without migration errors
2. `journal_entries` table created with all fields
3. Indexes `idx_entries_user_date` and `idx_entries_entry_date` created successfully
4. Application can query entries by user+date efficiently

---

## 5. TESTING PLAN

### 5.1 Manual Testing Steps

1. **Clear Database** (if migration already partially applied):
   ```bash
   rm -rf backend/pb_data/
   ```

2. **Start Server**:
   ```bash
   cd backend
   go run main.go serve
   ```
   Expected: Server starts without migration errors

3. **Verify Collections**:
   - Access PocketBase Admin UI (http://localhost:8090/_/)
   - Check `journal_entries` collection exists
   - Verify fields: user, entry_date, encrypted_content, etc.
   - Verify indexes exist

4. **Test CRUD Operations**:
   - Create a journal entry via API
   - Query entries by user and date
   - Verify query uses index (fast response)

### 5.2 Query Patterns Supported

**With current indexes**:
```sql
-- Fast: Uses idx_entries_user_date
SELECT * FROM journal_entries WHERE user = 'xxx' AND entry_date = '2026-02-03'

-- Fast: Uses idx_entries_entry_date
SELECT * FROM journal_entries WHERE entry_date >= '2026-02-01'

-- Fast: Uses idx_entries_user_date (user prefix)
SELECT * FROM journal_entries WHERE user = 'xxx' ORDER BY entry_date DESC
```

---

## 6. FILES MODIFIED

| File | Change Type | Description |
|------|-------------|-------------|
| `backend/migrations/001_initial_journal_schema.go` | Fix | Removed index `idx_entries_user_created` that referenced non-existent `created` column |

---

## 7. LESSONS LEARNED

### 7.1 PocketBase Migration Best Practices

1. **Auto-generated Fields**: When creating collections programmatically, explicitly add `AutodateField` for `created` and `updated` if you need to reference them

2. **Index Verification**: Always verify that indexed columns exist in the field definitions:
   ```go
   // Good practice: Define fields first
   entries.Fields.Add(&core.DateField{Name: "entry_date"})
   
   // Then reference them in indexes
   entries.AddIndex("idx_entry_date", false, "entry_date", "")
   ```

3. **Migration Testing**: Test migrations on clean databases before deploying

### 7.2 Field vs Index Alignment

```go
// ❌ Bad: Index references field not in schema
entries.AddIndex("idx_created", false, "created", "")

// ✅ Good: Add field first, then index
entries.Fields.Add(&core.AutodateField{
    Name:     "created",
    OnCreate: true,
})
entries.AddIndex("idx_created", false, "created", "")
```

---

## 8. RELATED DOCUMENTATION

- Spec 001: AI Journaling App Architecture
- Spec 002: Fix PocketBase Hook Compilation Error
- PocketBase Go Documentation: https://pocketbase.io/docs/go-overview/

---

**END OF SPECIFICATION**
