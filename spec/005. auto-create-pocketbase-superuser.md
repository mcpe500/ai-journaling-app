# 005. Auto-Create PocketBase Superuser from Environment Variables

## Document Information
- **ID**: 005
- **Title**: Auto-Create PocketBase Superuser from Environment Variables  
- **Date**: 2026-02-03
- **Status**: In Progress

---

## 1. TASK/PROMPT ANALYSIS

### 1.1 Original Prompt
```
tolong bacalah dan pahami @AGENTS.md kemudian tolong perbaiki:

# Auto-create superuser if env vars are present
if [ -n "$PB_ADMIN_EMAIL" ] && [ -n "$PB_ADMIN_PASSWORD" ]; then
    echo "Attempting to create superuser: $PB_ADMIN_EMAIL"
    /pb superuser upsert "$PB_ADMIN_EMAIL" "$PB_ADMIN_PASSWORD" || true
fi

maksudnya buatkan supaya di env nya ada pb admin supaya saya nggak perlu register admin baru langsung ada
```

**Translation**: Make the PocketBase superuser auto-create from environment variables so user doesn't need to manually register/create admin account.

### 1.2 Core Objective
**Goal**: Ensure PocketBase superuser is automatically created on first container startup using environment variables, eliminating the need for manual admin registration.

### 1.3 Why This Matters
- **Developer Experience**: No manual setup needed for new environments
- **Automation**: Essential for CI/CD and deployment automation
- **Consistency**: Every environment gets the same admin credentials from config
- **Convenience**: One less step in the setup process

---

## 2. CODEBASE UNDERSTANDING

### 2.1 Current Implementation

**File**: `backend/entrypoint.sh`
```bash
#!/bin/sh

# Auto-create superuser if env vars are present
if [ -n "$PB_ADMIN_EMAIL" ] && [ -n "$PB_ADMIN_PASSWORD" ]; then
    echo "Attempting to create superuser: $PB_ADMIN_EMAIL"
    /pb superuser upsert "$PB_ADMIN_EMAIL" "$PB_ADMIN_PASSWORD" || true
fi

# Start PocketBase
exec /pb serve --http=0.0.0.0:8090
```

**Environment Variables** (from `.env.example` and `docker-compose.yml`):
- `PB_ADMIN_EMAIL`: Admin email address
- `PB_ADMIN_PASSWORD`: Admin password
- Default values provided in docker-compose with fallbacks

### 2.2 Project Context
- **Framework**: PocketBase v0.23.8 (Go-based BaaS)
- **Deployment**: Docker containerized
- **Current Flow**: 
  1. Container starts
  2. entrypoint.sh runs
  3. Should create superuser if env vars present
  4. PocketBase starts

### 2.3 Existing Seeder (Redundant?)
File: `backend/migrations/seeder.go` also has `seedAdminUser()` function that creates a user in `_pb_users_auth_` collection.

**Difference**:
- `entrypoint.sh`: Creates **superuser** (system admin with full access)
- `seeder.go`: Creates **regular user** with 'admin' role in users collection

Both serve different purposes and should coexist.

---

## 3. PROBLEM ANALYSIS

### 3.1 Potential Issues with Current Code

1. **Race Condition**: Trying to create superuser before PocketBase is fully initialized
2. **Binary Path**: `/pb` might not be the correct path in all environments
3. **No Validation**: No email format validation or password strength check
4. **Silent Failures**: `|| true` hides all errors, making debugging impossible
5. **No Idempotency Check**: Doesn't check if superuser already exists, causing unnecessary errors
6. **Missing Wait**: PocketBase might need time to initialize its data directory

### 3.2 Root Cause Hypothesis
The command `/pb superuser upsert` likely requires PocketBase to be running or at least initialized, but the script tries to run it before starting PocketBase service.

---

## 4. SOLUTION DESIGN

### 4.1 Logic Changes

**Current Flow (Problematic)**:
```
1. Check env vars exist
2. Try to create superuser (may fail if PB not ready)
3. Start PocketBase
```

**Proposed Flow (Robust)**:
```
1. Validate env vars (format, non-empty)
2. Start PocketBase in background
3. Wait for PocketBase to be healthy (check HTTP endpoint)
4. Check if superuser already exists
5. Create superuser if doesn't exist
6. Bring PocketBase to foreground
```

### 4.2 Code Changes

**File to Modify**: `backend/entrypoint.sh`

**Changes**:
1. Add input validation for email format
2. Add check for PocketBase binary existence
3. Start PocketBase in background mode temporarily
4. Add wait loop for PocketBase to be ready (health check)
5. Check existing superusers before creating
6. Better error handling with informative messages
7. Proper cleanup and signal handling

### 4.3 Pseudocode

```bash
#!/bin/sh
set -e  # Exit on error

# Validation: Check env vars are set and valid
if [ -n "$PB_ADMIN_EMAIL" ] && [ -n "$PB_ADMIN_PASSWORD" ]; then
    # Validate email format (basic regex)
    if [[ ! "$PB_ADMIN_EMAIL" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$ ]]; then
        echo "Error: Invalid email format for PB_ADMIN_EMAIL"
        exit 1
    fi
    
    # Validate password not empty and minimum length
    if [ ${#PB_ADMIN_PASSWORD} -lt 8 ]; then
        echo "Error: PB_ADMIN_PASSWORD must be at least 8 characters"
        exit 1
    fi
    
    echo "Admin credentials configured: $PB_ADMIN_EMAIL"
fi

# Check PocketBase binary exists
if [ ! -f "/pb" ]; then
    echo "Error: PocketBase binary not found at /pb"
    exit 1
fi

# Function to check if PocketBase is healthy
check_pb_health() {
    curl -s http://localhost:8090/api/health > /dev/null 2>&1
    return $?
}

# Function to check if superuser exists
check_superuser_exists() {
    # Use PocketBase CLI to list superusers
    /pb superuser list 2>/dev/null | grep -q "$PB_ADMIN_EMAIL"
    return $?
}

# If admin credentials provided, we need to create superuser
if [ -n "$PB_ADMIN_EMAIL" ] && [ -n "$PB_ADMIN_PASSWORD" ]; then
    echo "Starting PocketBase temporarily to create superuser..."
    
    # Start PocketBase in background
    /pb serve --http=0.0.0.0:8090 &
    PB_PID=$!
    
    # Wait for PocketBase to be ready (max 30 seconds)
    echo "Waiting for PocketBase to initialize..."
    for i in $(seq 1 30); do
        if check_pb_health; then
            echo "PocketBase is ready!"
            break
        fi
        sleep 1
    done
    
    # Check if already exists
    if check_superuser_exists; then
        echo "Superuser already exists: $PB_ADMIN_EMAIL"
    else
        echo "Creating superuser: $PB_ADMIN_EMAIL"
        if /pb superuser upsert "$PB_ADMIN_EMAIL" "$PB_ADMIN_PASSWORD"; then
            echo "Superuser created successfully!"
        else
            echo "Warning: Failed to create superuser (may already exist)"
        fi
    fi
    
    # Stop background PocketBase
    kill $PB_PID 2>/dev/null
    wait $PB_PID 2>/dev/null
fi

# Start PocketBase in foreground (main process)
echo "Starting PocketBase..."
exec /pb serve --http=0.0.0.0:8090
```

---

## 5. IMPLEMENTATION DETAILS

### 5.1 Validation Requirements
- Email format validation (RFC 5322 subset)
- Password minimum 8 characters
- Check binary exists before execution
- Check PocketBase health endpoint

### 5.2 Error Handling Strategy
- Use `set -e` to exit on critical errors
- Validate inputs before execution
- Provide informative error messages
- Use `||` only for non-critical operations with logging
- Trap signals for cleanup

### 5.3 Idempotency
- Check if superuser exists before creation attempt
- Use `upsert` command (already does this, but we check first for better UX)
- Safe to run multiple times

---

## 6. TESTING PLAN

### 6.1 Test Cases

**Test Case 1: Fresh Start with Valid Credentials**
- Preconditions: No existing data directory, valid env vars set
- Steps: Start container
- Expected: Superuser created, PocketBase starts, can login with credentials
- Tracing: 
  1. entrypoint.sh starts
  2. Validates env vars
  3. Starts PB in background
  4. Waits for health check (1-5s)
  5. Checks superuser list (empty)
  6. Creates superuser
  7. Stops background PB
  8. Starts PB in foreground
  9. Admin can login at http://localhost:8090/_/ with provided credentials

**Test Case 2: Restart with Existing Superuser**
- Preconditions: Data directory exists, superuser already created
- Steps: Restart container
- Expected: Detects existing superuser, skips creation, starts normally
- Tracing:
  1. Validates env vars
  2. Starts PB in background
  3. Waits for health check
  4. Checks superuser list (found existing)
  5. Logs "Superuser already exists"
  6. Skips creation
  7. Starts PB in foreground

**Test Case 3: Invalid Email Format**
- Preconditions: PB_ADMIN_EMAIL="invalid-email"
- Steps: Start container
- Expected: Exits with error message before starting PB
- Tracing:
  1. Validates env vars
  2. Email regex fails
  3. Logs "Error: Invalid email format..."
  4. Exit code 1

**Test Case 4: Weak Password**
- Preconditions: PB_ADMIN_PASSWORD="123"
- Steps: Start container
- Expected: Exits with error message
- Tracing:
  1. Validates env vars
  2. Password length check fails (< 8 chars)
  3. Logs "Error: PB_ADMIN_PASSWORD must be at least 8 characters"
  4. Exit code 1

**Test Case 5: Missing Credentials**
- Preconditions: No PB_ADMIN_EMAIL or PB_ADMIN_PASSWORD set
- Steps: Start container
- Expected: Starts PocketBase without creating superuser
- Tracing:
  1. Checks env vars (empty)
  2. Skips superuser creation block
  3. Starts PB in foreground directly
  4. User must manually create superuser via UI

**Test Case 6: Binary Not Found**
- Preconditions: /pb doesn't exist
- Steps: Start container
- Expected: Exits with error before attempting operations
- Tracing:
  1. Checks if /pb exists (fails)
  2. Logs "Error: PocketBase binary not found..."
  3. Exit code 1

### 6.2 Manual Testing Steps

1. **Build and run fresh**:
   ```bash
   cd backend
   docker-compose down -v  # Remove old volumes
   docker-compose up --build
   ```
   - Check logs for "Superuser created successfully!"
   - Visit http://localhost:8090/_/
   - Login with admin@aijournal.app / admin123456
   - Should login successfully

2. **Restart container**:
   ```bash
   docker-compose restart
   ```
   - Check logs for "Superuser already exists"
   - Should not show errors
   - Can still login

3. **Test invalid config**:
   Edit docker-compose.yml, set `PB_ADMIN_EMAIL=invalid`
   ```bash
   docker-compose up
   ```
   - Should exit immediately with error
   - Should not start PocketBase

4. **Test without credentials**:
   Comment out admin env vars in docker-compose.yml
   ```bash
   docker-compose up
   ```
   - Should start PocketBase
   - Visit http://localhost:8090/_/
   - Should show initial setup page asking to create admin

---

## 7. FILES TO MODIFY

### 7.1 Primary Changes

**File**: `backend/entrypoint.sh`
- Complete rewrite with validation, health checks, and better error handling

### 7.2 No Changes Required
- `backend/docker-compose.yml` - Already has env vars configured
- `backend/.env.example` - Already has example values
- `backend/migrations/seeder.go` - Separate concern (creates regular user, not superuser)

---

## 8. RISK ANALYSIS

| Risk | Impact | Mitigation |
|------|--------|------------|
| PocketBase fails to start | High | Add retry logic and timeout |
| Race condition in health check | Medium | Wait up to 30 seconds with polling |
| Credentials logged | High | Never log password, only email |
| Container exits on error | Medium | Use `set -e` intentionally, validate inputs |
| Signal handling issues | Low | Proper trap and cleanup for background process |

---

## 9. DEPENDENCIES

- `curl` for health checks (should be in base image or add to Dockerfile)
- POSIX shell (`/bin/sh`)
- Standard Unix utilities: `grep`, `sleep`, `kill`

---

## 10. SUCCESS CRITERIA

1. Container starts successfully on first run with valid credentials
2. Superuser is created automatically and can login immediately
3. Container restarts without errors (idempotent)
4. Invalid credentials prevent startup (fail fast)
5. Missing credentials allow manual setup (backward compatible)
6. Logs are informative but don't expose passwords

---

## 11. IMPLEMENTATION STATUS

- [x] Spec written and approved
- [ ] entrypoint.sh updated
- [ ] Tested with fresh container
- [ ] Tested with restart
- [ ] Error cases validated
- [ ] Handoff document created

---

**END OF SPECIFICATION**
